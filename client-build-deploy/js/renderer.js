define(["camera","item","character","player","timer"],function(a,b,c,d,e){var f=Class.extend({init:function(a,b,c,d){this.game=a,this.context=b&&b.getContext?b.getContext("2d"):null,this.background=c&&c.getContext?c.getContext("2d"):null,this.foreground=d&&d.getContext?d.getContext("2d"):null,this.canvas=b,this.backcanvas=c,this.forecanvas=d,this.initFPS(),this.tilesize=16,this.upscaledRendering=this.context.mozImageSmoothingEnabled!==undefined,this.supportsSilhouettes=this.upscaledRendering,this.rescale(this.getScaleFactor()),this.lastTime=new Date,this.frameCount=0,this.maxFPS=this.FPS,this.realFPS=0,this.isDebugInfoVisible=!1,this.animatedTileCount=0,this.highTileCount=0,this.tablet=Detect.isTablet(window.innerWidth),this.fixFlickeringTimer=new e(100)},getWidth:function(){return this.canvas.width},getHeight:function(){return this.canvas.height},setTileset:function(a){this.tileset=a},getScaleFactor:function(){var a=window.innerWidth,b=window.innerHeight,c;this.mobile=!1,a<=1e3?(c=2,this.mobile=!0):a<=1500||b<=870?c=2:c=3;return c},rescale:function(a){this.scale=this.getScaleFactor(),this.createCamera(),this.context.mozImageSmoothingEnabled=!1,this.background.mozImageSmoothingEnabled=!1,this.foreground.mozImageSmoothingEnabled=!1,this.initFont(),this.initFPS(),!this.upscaledRendering&&this.game.map&&this.game.map.tilesets&&this.setTileset(this.game.map.tilesets[this.scale-1]),this.game.renderer&&this.game.setSpriteScale(this.scale)},createCamera:function(){this.camera=new a(this),this.camera.rescale(),this.canvas.width=this.camera.gridW*this.tilesize*this.scale,this.canvas.height=this.camera.gridH*this.tilesize*this.scale,log.debug("#entities set to "+this.canvas.width+" x "+this.canvas.height),this.backcanvas.width=this.canvas.width,this.backcanvas.height=this.canvas.height,log.debug("#background set to "+this.backcanvas.width+" x "+this.backcanvas.height),this.forecanvas.width=this.canvas.width,this.forecanvas.height=this.canvas.height,log.debug("#foreground set to "+this.forecanvas.width+" x "+this.forecanvas.height)},initFPS:function(){this.FPS=this.mobile?50:50},initFont:function(){var a;switch(this.scale){case 1:a=10;break;case 2:a=Detect.isWindows()?10:13;break;case 3:a=20}this.setFontSize(a)},setFontSize:function(a){var b=a+"px GraphicPixel";this.context.font=b,this.background.font=b},drawText:function(a,b,c,d,e,f){var g=this.context,h;switch(this.scale){case 1:h=3;break;case 2:h=3;break;case 3:h=5}a&&b&&c&&(g.save(),d&&(g.textAlign="center"),g.strokeStyle=f||"#373737",g.lineWidth=h,g.strokeText(a,b,c),g.fillStyle=e||"white",g.fillText(a,b,c),g.restore())},drawCellRect:function(a,b,c){this.context.save(),this.context.lineWidth=2*this.scale,this.context.strokeStyle=c,this.context.translate(a+2,b+2),this.context.strokeRect(0,0,this.tilesize*this.scale-4,this.tilesize*this.scale-4),this.context.restore()},drawCellHighlight:function(a,b,c){var d=this.scale,e=this.tilesize,f=a*e*d,g=b*e*d;this.drawCellRect(f,g,c)},drawTargetCell:function(){var a=this.game.getMouseGridPosition();this.game.targetCellVisible&&(a.x!==this.game.selectedX||a.y!==this.game.selectedY)&&this.drawCellHighlight(a.x,a.y,this.game.targetColor)},drawAttackTargetCell:function(){var a=this.game.getMouseGridPosition(),b=this.game.getEntityAt(a.x,a.y),c=this.scale;b&&this.drawCellRect(b.x*c,b.y*c,"rgba(255, 0, 0, 0.5)")},drawOccupiedCells:function(){var a=this.game.entityGrid;if(a)for(var b=0;b<a.length;b+=1)for(var c=0;c<a[b].length;c+=1)_.isNull(a[b][c])||this.drawCellHighlight(b,c,"rgba(50, 50, 255, 0.5)")},drawPathingCells:function(){var a=this.game.pathingGrid;if(a&&this.game.debugPathing)for(var b=0;b<a.length;b+=1)for(var c=0;c<a[b].length;c+=1)a[b][c]===1&&this.game.camera.isVisiblePosition(c,b)&&this.drawCellHighlight(c,b,"rgba(50, 50, 255, 0.5)")},drawSelectedCell:function(){var a=this.game.cursors.target,b=this.game.targetAnimation,c=this.upscaledRendering?1:this.scale,d=this.upscaledRendering?this.scale:1;if(this.game.selectedCellVisible)if(this.mobile||this.tablet){if(this.game.drawTarget){var e=this.game.selectedX,f=this.game.selectedY;this.drawCellHighlight(this.game.selectedX,this.game.selectedY,"rgb(51, 255, 0)"),this.lastTargetPos={x:e,y:f},this.game.drawTarget=!1}}else if(a&&b){var g=b.currentFrame,h=this.scale,e=g.x*c,f=g.y*c,i=a.width*c,j=a.height*c,k=16,l=this.game.selectedX*k*h,m=this.game.selectedY*k*h,n=i*d,o=j*d;this.context.save(),this.context.translate(l,m),this.context.drawImage(a.image,e,f,i,j,0,0,n,o),this.context.restore()}},clearScaledRect:function(a,b,c,d,e){var f=this.scale;a.clearRect(b*f,c*f,d*f,e*f)},drawCursor:function(){var a=this.game.mouse.x,b=this.game.mouse.y,c=this.scale,d=this.upscaledRendering?1:this.scale;this.context.save(),this.game.currentCursor&&this.game.currentCursor.isLoaded&&this.context.drawImage(this.game.currentCursor.image,0,0,14*d,14*d,a,b,14*c,14*c),this.context.restore()},drawScaledImage:function(a,b,c,d,e,f,g,h){var i=this.upscaledRendering?1:this.scale;_.each(arguments,function(a){if(_.isUndefined(a)||_.isNaN(a)||_.isNull(a)||a<0){log.error("x:"+c+" y:"+d+" w:"+e+" h:"+f+" dx:"+g+" dy:"+h,!0);throw Error("A problem occured when trying to draw on the canvas")}}),a.drawImage(b,c*i,d*i,e*i,f*i,g*this.scale,h*this.scale,e*this.scale,f*this.scale)},drawTile:function(a,b,c,d,e,f){var h=this.upscaledRendering?1:this.scale;b!==-1&&this.drawScaledImage(a,c,g(b+1,d/h)*this.tilesize,Math.floor(b/(d/h))*this.tilesize,this.tilesize,this.tilesize,g(f+1,e)*this.tilesize,Math.floor(f/e)*this.tilesize)},clearTile:function(a,b,c){var d=this.scale,e=this.tilesize,f=g(c+1,b)*e*d,h=Math.floor(c/b)*e*d,i=e*d,j=i;a.clearRect(f,h,j,i)},drawEntity:function(a){var d=a.sprite,e=this.game.shadows.small,f=a.currentAnimation,g=this.upscaledRendering?1:this.scale,h=this.upscaledRendering?this.scale:1;if(f&&d){var i=f.currentFrame,j=this.scale,k=i.x*g,l=i.y*g,m=d.width*g,n=d.height*g,o=d.offsetX*j,p=d.offsetY*j,q=a.x*j,r=a.y*j,s=m*h,t=n*h;a.isFading&&(this.context.save(),this.context.globalAlpha=a.fadingAlpha),!this.mobile&&!this.tablet&&this.drawEntityName(a),this.context.save(),a.flipSpriteX?(this.context.translate(q+this.tilesize*j,r),this.context.scale(-1,1)):a.flipSpriteY?(this.context.translate(q,r+t),this.context.scale(1,-1)):this.context.translate(q,r);if(a.isVisible()){a.hasShadow()&&this.context.drawImage(e.image,0,0,e.width*g,e.height*g,0,a.shadowOffsetY*h,e.width*g*h,e.height*g*h),this.context.drawImage(d.image,k,l,m,n,o,p,s,t);if(a instanceof b&&a.kind!==Types.Entities.CAKE){var u=this.game.sprites.sparks,f=this.game.sparksAnimation,i=f.currentFrame,v=u.width*i.index*g,w=u.height*f.row*g,x=u.width*g,y=u.width*g;this.context.drawImage(u.image,v,w,x,y,u.offsetX*j,u.offsetY*j,x*h,y*h)}}if(a instanceof c&&!a.isDead&&a.hasWeapon()){var z=this.game.sprites[a.getWeaponName()];if(z){var A=z.animationData[f.name],B=i.index<A.length?i.index:i.index%A.length;wx=z.width*B*g,wy=z.height*f.row*g,ww=z.width*g,wh=z.height*g,this.context.drawImage(z.image,wx,wy,ww,wh,z.offsetX*j,z.offsetY*j,ww*h,wh*h)}}this.context.restore(),a.isFading&&this.context.restore()}},drawEntities:function(a){var b=this;this.game.forEachVisibleEntityByDepth(function(c){c.isLoaded&&(a?c.isDirty&&(b.drawEntity(c),c.isDirty=!1,c.oldDirtyRect=c.dirtyRect,c.dirtyRect=null):b.drawEntity(c))})},drawDirtyEntities:function(){this.drawEntities(!0)},clearDirtyRect:function(a){this.context.clearRect(a.x,a.y,a.w,a.h)},clearDirtyRects:function(){var a=this,b=0;this.game.forEachVisibleEntityByDepth(function(c){c.isDirty&&c.oldDirtyRect&&(a.clearDirtyRect(c.oldDirtyRect),b+=1)}),this.game.forEachAnimatedTile(function(c){c.isDirty&&(a.clearDirtyRect(c.dirtyRect),b+=1)});if(this.game.clearTarget&&this.lastTargetPos){var c=this.lastTargetPos;rect=this.getTargetBoundingRect(c.x,c.y),this.clearDirtyRect(rect),this.game.clearTarget=!1,b+=1}!(b>0)},getEntityBoundingRect:function(a){var b={},c=this.scale,e;if(a instanceof d&&a.hasWeapon()){var f=this.game.sprites[a.getWeaponName()];e=f}else e=a.sprite;e&&(b.x=(a.x+e.offsetX-this.camera.x)*c,b.y=(a.y+e.offsetY-this.camera.y)*c,b.w=e.width*c,b.h=e.height*c,b.left=b.x,b.right=b.x+b.w,b.top=b.y,b.bottom=b.y+b.h);return b},getTileBoundingRect:function(a){var b={},c=this.game.map.width,d=this.scale,e=this.tilesize,f=a.index;b.x=(g(f+1,c)*e-this.camera.x)*d,b.y=(Math.floor(f/c)*e-this.camera.y)*d,b.w=e*d,b.h=e*d,b.left=b.x,b.right=b.x+b.w,b.top=b.y,b.bottom=b.y+b.h;return b},getTargetBoundingRect:function(a,b){var c={},d=this.scale,e=this.tilesize,f=a||this.game.selectedX,g=b||this.game.selectedY;c.x=(f*e-this.camera.x)*d,c.y=(g*e-this.camera.y)*d,c.w=e*d,c.h=e*d,c.left=c.x,c.right=c.x+c.w,c.top=c.y,c.bottom=c.y+c.h;return c},isIntersecting:function(a,b){return!(b.left>a.right||b.right<a.left||b.top>a.bottom||b.bottom<a.top)},drawEntityName:function(a){this.context.save();if(a.name&&a instanceof d){var b=a.id===this.game.playerId?"#fcda5c":"white";this.drawText(a.name,(a.x+8)*this.scale,(a.y+a.nameOffsetY)*this.scale,!0,b)}this.context.restore()},drawTerrain:function(){var a=this,b=this.game.map,c=this.tileset.width/b.tilesize;this.game.forEachVisibleTile(function(d,e){!b.isHighTile(d)&&!b.isAnimatedTile(d)&&a.drawTile(a.background,d,a.tileset,c,b.width,e)},1)},drawAnimatedTiles:function(a){var b=this,c=this.game.map,d=this.tileset.width/c.tilesize;this.animatedTileCount=0,this.game.forEachAnimatedTile(function(e){a?e.isDirty&&(b.drawTile(b.context,e.id,b.tileset,d,c.width,e.index),e.isDirty=!1):(b.drawTile(b.context,e.id,b.tileset,d,c.width,e.index),b.animatedTileCount+=1)})},drawDirtyAnimatedTiles:function(){this.drawAnimatedTiles(!0)},drawHighTiles:function(a){var b=this,c=this.game.map,d=this.tileset.width/c.tilesize;this.highTileCount=0,this.game.forEachVisibleTile(function(e,f){c.isHighTile(e)&&(b.drawTile(a,e,b.tileset,d,c.width,f),b.highTileCount+=1)},1)},drawBackground:function(a,b){a.fillStyle=b,a.fillRect(0,0,this.canvas.width,this.canvas.height)},drawFPS:function(){var a=new Date,b=a.getTime()-this.lastTime.getTime();b>=1e3&&(this.realFPS=this.frameCount,this.frameCount=0,this.lastTime=a),this.frameCount++,this.drawText("FPS: "+this.realFPS,30,30,!1)},drawDebugInfo:function(){this.isDebugInfoVisible&&(this.drawFPS(),this.drawText("A: "+this.animatedTileCount,100,30,!1),this.drawText("H: "+this.highTileCount,140,30,!1))},drawCombatInfo:function(){var a=this;switch(this.scale){case 2:this.setFontSize(20);break;case 3:this.setFontSize(30)}this.game.infoManager.forEachInfo(function(b){a.context.save(),a.context.globalAlpha=b.opacity,a.drawText(b.value,(b.x+8)*a.scale,Math.floor(b.y*a.scale),!0,b.fillColor,b.strokeColor),a.context.restore()}),this.initFont()},setCameraView:function(a){a.translate(-this.camera.x*this.scale,-this.camera.y*this.scale)},clearScreen:function(a){a.clearRect(0,0,this.canvas.width,this.canvas.height)},getPlayerImage:function(){var a=document.createElement("canvas"),b=a.getContext("2d"),c=this.upscaledRendering?1:this.scale,d=this.game.player,e=d.getArmorSprite(),f=e.animationData.idle_down,g=f.row,h=e.width*c,i=e.height*c,j=g*i,k=this.game.sprites[this.game.player.getWeaponName()],l=k.width*c,m=k.height*c,n=m*g,o=(k.offsetX-e.offsetX)*c,p=(k.offsetY-e.offsetY)*c,q=this.game.shadows.small,r=q.width*c,s=q.height*c,t=-e.offsetX*c;oy=-e.offsetY*c,a.width=h,a.height=i,b.clearRect(0,0,h,i),b.drawImage(q.image,0,0,r,s,t,oy,r,s),b.drawImage(e.image,0,j,h,i,0,0,h,i),b.drawImage(k.image,0,n,l,m,o,p,l,m);return a.toDataURL("image/png")},renderStaticCanvases:function(){this.background.save(),this.setCameraView(this.background),this.drawTerrain(),this.background.restore();if(this.mobile||this.tablet)this.clearScreen(this.foreground),this.foreground.save(),this.setCameraView(this.foreground),this.drawHighTiles(this.foreground),this.foreground.restore()},renderFrame:function(){this.mobile||this.tablet?this.renderFrameMobile():this.renderFrameDesktop()},renderFrameDesktop:function(){this.clearScreen(this.context),this.context.save(),this.setCameraView(this.context),this.drawAnimatedTiles(),this.game.started&&(this.drawSelectedCell(),this.drawTargetCell()),this.drawPathingCells(),this.drawEntities(),this.drawCombatInfo(),this.drawHighTiles(this.context),this.context.restore(),this.drawCursor(),this.drawDebugInfo()},renderFrameMobile:function(){this.clearDirtyRects(),this.preventFlickeringBug(),this.context.save(),this.setCameraView(this.context),this.drawDirtyAnimatedTiles(),this.drawSelectedCell(),this.drawDirtyEntities(),this.context.restore()},preventFlickeringBug:function(){this.fixFlickeringTimer.isOver(this.game.currentTime)&&(this.background.fillRect(0,0,0,0),this.context.fillRect(0,0,0,0),this.foreground.fillRect(0,0,0,0))}}),g=function(a,b){return a==0?0:a%b==0?b-1:a%b-1};return f})