define(["character","timer"],function(a,b){var c=Class.extend({init:function(a){this.game=a,this.playerAggroTimer=new b(1e3)},update:function(){this.updateZoning(),this.updateCharacters(),this.updatePlayerAggro(),this.updateTransitions(),this.updateAnimations(),this.updateAnimatedTiles(),this.updateChatBubbles(),this.updateInfos()},updateCharacters:function(){var b=this;this.game.forEachEntity(function(c){var d=c instanceof a;c.isLoaded&&(d&&(b.updateCharacter(c),b.game.onCharacterUpdate(c)),b.updateEntityFading(c))})},updatePlayerAggro:function(){var a=this.game.currentTime,b=this.game.player;b&&!b.isMoving()&&!b.isAttacking()&&this.playerAggroTimer.isOver(a)&&b.checkAggro()},updateEntityFading:function(a){if(a&&a.isFading){var b=1e3,c=this.game.currentTime,d=c-a.startFadingTime;d>b?(this.isFading=!1,a.fadingAlpha=1):a.fadingAlpha=d/b}},updateTransitions:function(){var a=this,b=null,c=this.game.currentZoning;this.game.forEachEntity(function(c){b=c.movement,b&&b.inProgress&&b.step(a.game.currentTime)}),c&&c.inProgress&&c.step(this.game.currentTime)},updateZoning:function(){var a=this.game,b=a.camera,c=a.currentZoning,d=3,e=16,f=500;if(c&&c.inProgress===!1){var g=this.game.zoningOrientation,h=endValue=offset=0,i=null,j=null;if(g===Types.Orientations.LEFT||g===Types.Orientations.RIGHT)offset=(b.gridW-2)*e,h=g===Types.Orientations.LEFT?b.x-e:b.x+e,endValue=g===Types.Orientations.LEFT?b.x-offset:b.x+offset,i=function(c){b.setPosition(c,b.y),a.initAnimatedTiles(),a.renderer.renderStaticCanvases()},j=function(){b.setPosition(c.endValue,b.y),a.endZoning()};else if(g===Types.Orientations.UP||g===Types.Orientations.DOWN)offset=(b.gridH-2)*e,h=g===Types.Orientations.UP?b.y-e:b.y+e,endValue=g===Types.Orientations.UP?b.y-offset:b.y+offset,i=function(c){b.setPosition(b.x,c),a.initAnimatedTiles(),a.renderer.renderStaticCanvases()},j=function(){b.setPosition(b.x,c.endValue),a.endZoning()};c.start(this.game.currentTime,i,j,h,endValue,f)}},updateCharacter:function(a){var b=this,c=Math.round(16/Math.round(a.moveSpeed/(1e3/this.game.renderer.FPS)));a.isMoving()&&a.movement.inProgress===!1&&(a.orientation===Types.Orientations.LEFT?a.movement.start(this.game.currentTime,function(b){a.x=b,a.hasMoved()},function(){a.x=a.movement.endValue,a.hasMoved(),a.nextStep()},a.x-c,a.x-16,a.moveSpeed):a.orientation===Types.Orientations.RIGHT?a.movement.start(this.game.currentTime,function(b){a.x=b,a.hasMoved()},function(){a.x=a.movement.endValue,a.hasMoved(),a.nextStep()},a.x+c,a.x+16,a.moveSpeed):a.orientation===Types.Orientations.UP?a.movement.start(this.game.currentTime,function(b){a.y=b,a.hasMoved()},function(){a.y=a.movement.endValue,a.hasMoved(),a.nextStep()},a.y-c,a.y-16,a.moveSpeed):a.orientation===Types.Orientations.DOWN&&a.movement.start(this.game.currentTime,function(b){a.y=b,a.hasMoved()},function(){a.y=a.movement.endValue,a.hasMoved(),a.nextStep()},a.y+c,a.y+16,a.moveSpeed))},updateAnimations:function(){var a=this.game.currentTime;this.game.forEachEntity(function(b){var c=b.currentAnimation;c&&c.update(a)&&b.setDirty()});var b=this.game.sparksAnimation;b&&b.update(a);var c=this.game.targetAnimation;c&&c.update(a)},updateAnimatedTiles:function(){var a=this,b=this.game.currentTime;this.game.forEachAnimatedTile(function(c){c.animate(b)&&(c.isDirty=!0,c.dirtyRect=a.game.renderer.getTileBoundingRect(c),(a.game.renderer.mobile||a.game.renderer.tablet)&&a.game.checkOtherDirtyRects(c.dirtyRect,c,c.x,c.y))})},updateChatBubbles:function(){var a=this.game.currentTime;this.game.bubbleManager.update(a)},updateInfos:function(){var a=this.game.currentTime;this.game.infoManager.update(a)}});return c})