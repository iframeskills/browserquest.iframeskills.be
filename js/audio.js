define(["area"],function(a){var b=Class.extend({init:function(a){var b=this;this.enabled=!0,this.extension=Detect.canPlayMP3()?"mp3":"ogg",this.sounds={},this.game=a,this.currentMusic=null,this.areas=[],this.musicNames=["village","beach","forest","cave","desert","lavaland","boss"],this.soundNames=["loot","hit1","hit2","hurt","heal","chat","revive","death","firefox","achievement","kill1","kill2","noloot","teleport","chest","npc","npc-end"];var c=function(){var a=_.size(b.soundNames);log.info("Loading sound files..."),_.each(b.soundNames,function(c){b.loadSound(c,function(){a-=1,a===0&&(Detect.isSafari()||d())})})},d=function(){b.game.renderer.mobile||(log.info("Loading music files..."),b.loadMusic(b.musicNames.shift(),function(){_.each(b.musicNames,function(a){b.loadMusic(a)})}))};!Detect.isSafari()||!Detect.isWindows()?c():this.enabled=!1},toggle:function(){this.enabled?(this.enabled=!1,this.currentMusic&&this.resetMusic(this.currentMusic)):(this.enabled=!0,this.currentMusic&&(this.currentMusic=null),this.updateMusic())},load:function(a,b,c,d){var e=a+b+"."+this.extension,f=document.createElement("audio"),g=this;f.addEventListener("canplaythrough",function(a){this.removeEventListener("canplaythrough",arguments.callee,!1),log.debug(e+" is ready to play."),c&&c()},!1),f.addEventListener("error",function(a){log.error("Error: "+e+" could not be loaded."),g.sounds[b]=null},!1),f.preload="auto",f.autobuffer=!0,f.src=e,f.load(),this.sounds[b]=[f],_.times(d-1,function(){g.sounds[b].push(f.cloneNode(!0))})},loadSound:function(a,b){this.load("audio/sounds/",a,b,4)},loadMusic:function(a,b){this.load("audio/music/",a,b,1);var c=this.sounds[a][0];c.loop=!0,c.addEventListener("ended",function(){c.play()},!1)},getSound:function(a){if(!this.sounds[a])return null;var b=_.detect(this.sounds[a],function(a){return a.ended||a.paused});b&&b.ended?b.currentTime=0:b=this.sounds[a][0];return b},playSound:function(a){var b=this.enabled&&this.getSound(a);b&&b.play()},addArea:function(b,c,d,e,f){var g=new a(b,c,d,e);g.musicName=f,this.areas.push(g)},getSurroundingMusic:function(a){var b=null,c=_.detect(this.areas,function(b){return b.contains(a)});c&&(b={sound:this.getSound(c.musicName),name:c.musicName});return b},updateMusic:function(){if(this.enabled){var a=this.getSurroundingMusic(this.game.player);a?this.isCurrentMusic(a)||(this.currentMusic&&this.fadeOutCurrentMusic(),this.playMusic(a)):this.fadeOutCurrentMusic()}},isCurrentMusic:function(a){return this.currentMusic&&a.name===this.currentMusic.name},playMusic:function(a){this.enabled&&a&&a.sound&&(a.sound.fadingOut?this.fadeInMusic(a):(a.sound.volume=1,a.sound.play()),this.currentMusic=a)},resetMusic:function(a){a&&a.sound&&a.sound.readyState>0&&(a.sound.pause(),a.sound.currentTime=0)},fadeOutMusic:function(a,b){var c=this;a&&!a.sound.fadingOut&&(this.clearFadeIn(a),a.sound.fadingOut=setInterval(function(){var d=.02;volume=a.sound.volume-d,c.enabled&&volume>=d?a.sound.volume=volume:(a.sound.volume=0,c.clearFadeOut(a),b(a))},50))},fadeInMusic:function(a){var b=this;a&&!a.sound.fadingIn&&(this.clearFadeOut(a),a.sound.fadingIn=setInterval(function(){var c=.01;volume=a.sound.volume+c,b.enabled&&volume<1-c?a.sound.volume=volume:(a.sound.volume=1,b.clearFadeIn(a))},30))},clearFadeOut:function(a){a.sound.fadingOut&&(clearInterval(a.sound.fadingOut),a.sound.fadingOut=null)},clearFadeIn:function(a){a.sound.fadingIn&&(clearInterval(a.sound.fadingIn),a.sound.fadingIn=null)},fadeOutCurrentMusic:function(){var a=this;this.currentMusic&&(this.fadeOutMusic(this.currentMusic,function(b){a.resetMusic(b)}),this.currentMusic=null)}});return b})