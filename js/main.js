define(["jquery","app"],function(a,b){var c,d,e=function(){a(document).ready(function(){c=new b,c.center(),Detect.isWindows()&&a("body").addClass("windows"),Detect.isOpera()&&a("body").addClass("opera"),a("body").click(function(b){a("#parchment").hasClass("credits")&&c.toggleCredits(),a("#parchment").hasClass("about")&&c.toggleAbout()}),a(".barbutton").click(function(){a(this).toggleClass("active")}),a("#chatbutton").click(function(){a("#chatbutton").hasClass("active")?c.showChat():c.hideChat()}),a("#helpbutton").click(function(){c.toggleAbout()}),a("#achievementsbutton").click(function(){c.toggleAchievements(),c.blinkInterval&&clearInterval(c.blinkInterval),a(this).removeClass("blink")}),a("#instructions").click(function(){c.hideWindows()}),a("#playercount").click(function(){c.togglePopulationInfo()}),a("#population").click(function(){c.togglePopulationInfo()}),a(".clickable").click(function(a){a.stopPropagation()}),a("#toggle-credits").click(function(){c.toggleCredits()}),a("#create-new span").click(function(){c.animateParchment("loadcharacter","confirmation")}),a(".delete").click(function(){c.storage.clear(),c.animateParchment("confirmation","createcharacter")}),a("#cancel span").click(function(){c.animateParchment("confirmation","loadcharacter")}),a(".ribbon").click(function(){c.toggleAbout()}),a("#nameinput").bind("keyup",function(){c.toggleButton()}),a("#previous").click(function(){var b=a("#achievements");if(c.currentPage===1)return!1;c.currentPage-=1,b.removeClass().addClass("active page"+c.currentPage)}),a("#next").click(function(){var b=a("#achievements"),d=a("#lists"),e=d.children("ul").length;if(c.currentPage===e)return!1;c.currentPage+=1,b.removeClass().addClass("active page"+c.currentPage)}),a("#notifications div").bind(TRANSITIONEND,c.resetMessagesPosition.bind(c)),a(".close").click(function(){c.hideWindows()}),a(".twitter").click(function(){var b=a(this).attr("href");c.openPopup("twitter",b);return!1}),a(".facebook").click(function(){var b=a(this).attr("href");c.openPopup("facebook",b);return!1});var d=c.storage.data;d.hasAlreadyPlayed&&d.player.name&&d.player.name!==""&&(a("#playername").html(d.player.name),a("#playerimage").attr("src",d.player.image)),a(".play div").click(function(b){var d=a("#nameinput").attr("value"),e=a("#playername").html(),f=d||e;c.tryStartingGame(f)}),document.addEventListener("touchstart",function(){},!1),a("#resize-check").bind("transitionend",c.resizeUi.bind(c)),a("#resize-check").bind("webkitTransitionEnd",c.resizeUi.bind(c)),a("#resize-check").bind("oTransitionEnd",c.resizeUi.bind(c)),log.info("App initialized."),f()})},f=function(){require(["game"],function(b){var e=document.getElementById("entities"),f=document.getElementById("background"),g=document.getElementById("foreground"),h=document.getElementById("chatinput");d=new b(c),d.setup("#bubbles",e,f,g,h),d.setStorage(c.storage),c.setGame(d),c.isDesktop&&c.supportsWorkers&&d.loadMap(),d.onGameStart(function(){c.initEquipmentIcons()}),d.onDisconnect(function(b){a("#death").find("p").html(b+"<em>Please reload the page.</em>"),a("#respawn").hide()}),d.onPlayerDeath(function(){a("body").hasClass("credits")&&a("body").removeClass("credits"),a("body").addClass("death")}),d.onPlayerEquipmentChange(function(){c.initEquipmentIcons()}),d.onPlayerInvincible(function(){a("#hitpoints").toggleClass("invincible")}),d.onNbPlayersChange(function(b,c){var d=function(b){a("#instance-population").find("span:nth-child(2)").text(b),a("#playercount").find("span:nth-child(2)").text(b)},e=function(b){a("#world-population").find("span:nth-child(2)").text(b)};a("#playercount").find("span.count").text(b),a("#instance-population").find("span").text(b),b==1?d("player"):d("players"),a("#world-population").find("span").text(c),c==1?e("player"):e("players")}),d.onAchievementUnlock(function(a,b,d){c.unlockAchievement(a,b)}),d.onNotification(function(a){c.showMessage(a)}),c.initHealthBar(),a("#nameinput").attr("value",""),a("#chatbox").attr("value",""),d.renderer.mobile||d.renderer.tablet?a("#foreground").bind("touchstart",function(a){c.center(),c.setMouseCoordinates(a.originalEvent.touches[0]),d.click(),c.hideWindows()}):a("#foreground").click(function(a){c.center(),c.setMouseCoordinates(a),d&&d.click(),c.hideWindows()}),a("body").unbind("click"),a("body").click(function(b){var e=!1;a("#parchment").hasClass("credits")&&(d.started?(c.closeInGameCredits(),e=!0):c.toggleCredits()),a("#parchment").hasClass("about")&&(d.started?(c.closeInGameAbout(),e=!0):c.toggleAbout()),d.started&&!d.renderer.mobile&&d.player&&!e&&d.click()}),a("#respawn").click(function(b){d.audioManager.playSound("revive"),d.restart(),a("body").removeClass("death")}),a(document).mousemove(function(a){c.setMouseCoordinates(a),d.started&&d.movecursor()}),a(document).keydown(function(b){var d=b.which,e=a("#chatinput");d===13&&(a("#chatbox").hasClass("active")?c.hideChat():c.showChat())}),a("#chatinput").keydown(function(b){var e=b.which,f=a("#chatinput");if(e===13){if(f.attr("value")!==""){d.player&&d.say(f.attr("value")),f.attr("value",""),c.hideChat(),a("#foreground").focus();return!1}c.hideChat();return!1}if(e===27){c.hideChat();return!1}}),a("#nameinput").keypress(function(b){var d=a("#nameinput"),e=d.attr("value");if(b.keyCode===13){if(e!==""){c.tryStartingGame(e,function(){d.blur()});return!1}return!1}}),a("#mutebutton").click(function(){d.audioManager.toggle()}),a(document).bind("keydown",function(b){var e=b.which,f=a("#chatinput");if(a("#chatinput:focus").size()==0&&a("#nameinput:focus").size()==0){if(e===13&&d.ready){f.focus();return!1}if(e===32)return!1;if(e===70)return!1;if(e===27){c.hideWindows(),_.each(d.player.attackers,function(a){a.stop()});return!1}if(e===65)return!1}else if(e===13&&d.ready){f.focus();return!1}}),d.renderer.tablet&&a("body").addClass("tablet")})};e()})